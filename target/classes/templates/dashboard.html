<!DOCTYPE html>
<html class="light" lang="zh-CN" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>集群概览 - 灵犀平台</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <!-- Marked.js for Markdown rendering -->
    <script src="https://unpkg.com/marked@4.3.0/marked.min.js"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2b9dee",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101a22",
                    },
                    fontFamily: {
                        "display": ["Inter", "system-ui", "-apple-system", "sans-serif"],
                    }
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 20;
            vertical-align: middle;
        }
        body { font-family: 'Inter', "Microsoft YaHei", sans-serif; }
        
        /* Markdown Styles */
        .markdown-body {
            line-height: 1.6;
            color: inherit;
        }
        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3,
        .markdown-body h4 {
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.75em;
            line-height: 1.25;
        }
        .markdown-body h1 { font-size: 1.5em; }
        .markdown-body h2 { font-size: 1.25em; }
        .markdown-body h3 { font-size: 1.1em; }
        .markdown-body h4 { font-size: 1em; }
        .markdown-body p {
            margin-bottom: 1em;
        }
        .markdown-body ul,
        .markdown-body ol {
            margin: 0.5em 0;
            padding-left: 2em;
        }
        .markdown-body li {
            margin: 0.25em 0;
        }
        .markdown-body code {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 0.2em 0.4em;
            border-radius: 0.25rem;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }
        .dark .markdown-body code {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .markdown-body pre {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 1em;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1em 0;
        }
        .dark .markdown-body pre {
            background-color: rgba(0, 0, 0, 0.3);
        }
        .markdown-body pre code {
            background-color: transparent;
            padding: 0;
        }
        .markdown-body blockquote {
            border-left: 4px solid #8b5cf6;
            padding-left: 1em;
            margin: 1em 0;
            color: #6b7280;
        }
        .dark .markdown-body blockquote {
            color: #9ca3af;
        }
        .markdown-body strong {
            font-weight: 600;
        }
        .markdown-body em {
            font-style: italic;
        }
        .markdown-body a {
            color: #2b9dee;
            text-decoration: underline;
        }
        .markdown-body a:hover {
            color: #1e7cd6;
        }
        .markdown-body table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        .markdown-body table th,
        .markdown-body table td {
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 0.5em;
            text-align: left;
        }
        .dark .markdown-body table th,
        .dark .markdown-body table td {
            border-color: rgba(255, 255, 255, 0.1);
        }
        .markdown-body table th {
            background-color: rgba(0, 0, 0, 0.05);
            font-weight: 600;
        }
        .dark .markdown-body table th {
            background-color: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 antialiased min-h-screen">
    <header
        class="sticky top-0 z-50 w-full bg-white dark:bg-background-dark border-b border-slate-200 dark:border-slate-800">
        <div class="max-w-[1440px] mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-blue-500 rounded-lg flex items-center justify-center text-white shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5zm0 2.18l8 4v8.82c0 4.54-3.07 8.83-7.09 9.95C8.07 19.83 5 15.54 5 11V8.18l7-3.5z"/>
                        <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                    </svg>
                </div>
                <h1 class="text-lg font-bold tracking-tight bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">灵犀平台</h1>
            </div>
            <nav class="hidden md:flex items-center gap-8">
                <a class="text-sm font-bold text-primary border-b-2 border-primary py-5" href="/dashboard">集群概览</a>
                <a class="text-sm font-medium text-slate-600 dark:text-slate-400 hover:text-primary transition-colors"
                    href="/">Pod 列表</a>
                <a class="text-sm font-medium text-slate-600 dark:text-slate-400 hover:text-primary transition-colors"
                    href="/store">存储卷</a>
                <a class="text-sm font-medium text-slate-600 dark:text-slate-400 hover:text-primary transition-colors"
                    href="/memory">内存管理</a>
                <a class="text-sm font-medium text-slate-600 dark:text-slate-400 hover:text-primary transition-colors"
                    href="/aitools">AI 工具箱</a>
            </nav>
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-slate-200 overflow-hidden ml-2">
                    <img alt="User Profile" class="w-full h-full object-cover"
                        src="https://lh3.googleusercontent.com/aida-public/AB6AXuBJq5blQRMAftLWJpTxiZJprJqmgSCdQxYsQawbg-Ddra9iSfhhc0xJoqeKEZ0_gGhOjTD0BCT1DdnpQq7GhafGMIZ5w9L-3ohr_VMngtbViq1IWo80OJlYKJnTeAJsnrR3DSHe6P2GBmZLyvRldN2J4VugN4esw21fL6mb85QbhWdGz3fZDO-XB9OJfABjLTI1GUlyih5T43BSdUi3XkRzGM0ZNKqZcFrbM9WQx6teonyPrMqzlJXwyhtQjO8zs_cwi8x-emLwJoy7" />
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-[1440px] mx-auto p-6 space-y-6">
        <div th:if="${error}" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative"
            role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline" th:text="${error}"></span>
        </div>

        <!-- Overview Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Node Status -->
            <div
                class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-slate-500">集群节点</h3>
                    <span class="p-2 bg-blue-50 text-blue-600 rounded-lg material-symbols-outlined">dns</span>
                </div>
                <div class="flex items-baseline gap-2">
                    <span class="text-3xl font-bold text-slate-900 dark:text-white" th:text="${totalNodes}">0</span>
                    <span class="text-sm text-slate-500">Total</span>
                </div>
                <div class="mt-4 flex items-center text-sm">
                    <span class="flex items-center text-emerald-600 gap-1 font-medium">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full"></span>
                        <span th:text="${readyNodes}">0</span> Ready
                    </span>
                </div>
            </div>

            <!-- Pod Status -->
            <div
                class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-slate-500">Pod 实例</h3>
                    <span class="p-2 bg-purple-50 text-purple-600 rounded-lg material-symbols-outlined">apps</span>
                </div>
                <div class="flex items-baseline gap-2">
                    <span class="text-3xl font-bold text-slate-900 dark:text-white" th:text="${totalPods}">0</span>
                    <span class="text-sm text-slate-500">Total</span>
                </div>
                <div class="mt-4 flex items-center gap-4 text-xs font-medium">
                    <span class="flex items-center text-emerald-600 gap-1">
                        <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></span>
                        <span th:text="${runningPods}">0</span> Run
                    </span>
                    <span class="flex items-center text-amber-600 gap-1">
                        <span class="w-1.5 h-1.5 bg-amber-500 rounded-full"></span>
                        <span th:text="${pendingPods}">0</span> Pend
                    </span>
                    <span class="flex items-center text-red-600 gap-1">
                        <span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span>
                        <span th:text="${failedPods}">0</span> Fail
                    </span>
                </div>
            </div>

            <!-- Deployments -->
            <div
                class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-slate-500">Deployments</h3>
                    <span
                        class="p-2 bg-indigo-50 text-indigo-600 rounded-lg material-symbols-outlined">deployed_code</span>
                </div>
                <div class="flex items-baseline gap-2">
                    <span class="text-3xl font-bold text-slate-900 dark:text-white"
                        th:text="${totalDeployments}">0</span>
                    <span class="text-sm text-slate-500">Total</span>
                </div>
                <div class="mt-4 text-sm text-slate-500">
                    Active Workloads
                </div>
            </div>

            <!-- Health/Events Summary -->
            <div
                class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-slate-500">System Health</h3>
                    <span
                        class="p-2 bg-emerald-50 text-emerald-600 rounded-lg material-symbols-outlined">health_and_safety</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-lg font-bold text-emerald-600">Healthy</span>
                </div>
                <div class="mt-2 text-xs text-slate-500">
                    Cluster is operating normally.
                </div>
            </div>
        </div>

        <!-- Recent Events -->
        <div
            class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-slate-400">notifications</span>
                    Recent Events
                </h3>
                <span class="text-xs text-slate-500">Last 10 Cluster Events</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 dark:bg-slate-900/50 text-xs uppercase text-slate-500 font-semibold">
                        <tr>
                            <th class="px-6 py-3">Type</th>
                            <th class="px-6 py-3">Reason</th>
                            <th class="px-6 py-3">Object</th>
                            <th class="px-6 py-3">Message</th>
                            <th class="px-6 py-3">Last Seen</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                        <tr th:each="event : ${events}"
                            class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                            <td class="px-6 py-4">
                                <span
                                    th:classappend="${event.type == 'Warning'} ? 'bg-amber-100 text-amber-800' : 'bg-slate-100 text-slate-800'"
                                    class="px-2 py-1 rounded text-xs font-bold" th:text="${event.type}">Type</span>
                            </td>
                            <td class="px-6 py-4 font-medium" th:text="${event.reason}">Reason</td>
                            <td class="px-6 py-4 text-slate-500"
                                th:text="${event.involvedObject.kind + '/' + event.involvedObject.name}">Object</td>
                            <td class="px-6 py-4 max-w-md">
                                <div class="flex items-center gap-2">
                                    <span class="truncate flex-1" th:text="${event.message}">Message</span>
                                    <button onclick="showEventMessageFromRow(this)" 
                                            class="p-1 text-primary hover:bg-primary/10 rounded transition-colors" 
                                            title="查看完整消息"
                                            th:data-message="${event.message}"
                                            th:data-type="${event.type}"
                                            th:data-reason="${event.reason}"
                                            th:data-object="${event.involvedObject.kind + '/' + event.involvedObject.name}"
                                            th:data-time="${event.lastTimestamp}">
                                        <span class="material-symbols-outlined text-sm">open_in_new</span>
                                    </button>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-slate-400 text-xs" th:text="${event.lastTimestamp}">Time</td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(events)}">
                            <td colspan="5" class="px-6 py-8 text-center text-slate-500">No recent events found.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Event Message Modal -->
    <dialog id="eventMessageModal" class="fixed inset-0 z-50 hidden w-full h-full overflow-y-auto">
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" onclick="closeEventMessageModal()"></div>
        <div class="relative mx-auto my-8 max-w-2xl bg-white dark:bg-slate-800 rounded-xl shadow-xl">
            <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined">info</span>
                    事件详情
                </h3>
                <button onclick="closeEventMessageModal()" class="p-2 text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase">类型</label>
                    <p class="mt-1">
                        <span id="modal-event-type" class="px-2 py-1 rounded text-xs font-bold">Type</span>
                    </p>
                </div>
                <div>
                    <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase">原因</label>
                    <p id="modal-event-reason" class="mt-1 text-sm font-medium text-slate-900 dark:text-white">Reason</p>
                </div>
                <div>
                    <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase">对象</label>
                    <p id="modal-event-object" class="mt-1 text-sm text-slate-500 dark:text-slate-400">Object</p>
                </div>
                <div>
                    <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase">时间</label>
                    <p id="modal-event-time" class="mt-1 text-sm text-slate-400 dark:text-slate-500">Time</p>
                </div>
                <div>
                    <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase">消息内容</label>
                    <div class="mt-2 p-4 bg-slate-50 dark:bg-slate-900/50 rounded-lg border border-slate-200 dark:border-slate-700">
                        <p id="modal-event-message" class="text-sm text-slate-900 dark:text-slate-100 whitespace-pre-wrap break-words">Message</p>
                    </div>
                </div>
                <div id="ai-analysis-section" class="hidden">
                    <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">psychology</span>
                        AI 智能分析
                    </label>
                    <div class="mt-2 p-4 bg-gradient-to-br from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 rounded-lg border border-purple-200 dark:border-purple-800">
                        <div id="ai-analysis-loading" class="hidden flex items-center gap-2 text-purple-600 dark:text-purple-400">
                            <span class="material-symbols-outlined animate-spin">sync</span>
                            <span class="text-sm">AI 正在分析中...</span>
                        </div>
                        <div id="ai-analysis-content" class="hidden">
                            <div id="ai-analysis-text" class="text-sm text-slate-900 dark:text-slate-100 markdown-body"></div>
                        </div>
                        <div id="ai-analysis-error" class="hidden text-sm text-red-600 dark:text-red-400"></div>
                    </div>
                </div>
            </div>
            <div class="flex justify-between items-center p-6 border-t border-slate-200 dark:border-slate-700">
                <button onclick="analyzeEventWithAI()" 
                        id="ai-analysis-btn"
                        class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg hover:from-purple-600 hover:to-blue-600 transition-all shadow-sm">
                    <span class="material-symbols-outlined text-sm">psychology</span>
                    <span>AI 分析原因</span>
                </button>
                <button onclick="closeEventMessageModal()" 
                        class="px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                    关闭
                </button>
            </div>
        </div>
    </dialog>

    <script>
        function showEventMessageFromRow(button) {
            const message = button.getAttribute('data-message') || '无消息';
            const type = button.getAttribute('data-type') || 'Normal';
            const reason = button.getAttribute('data-reason') || '未知';
            const object = button.getAttribute('data-object') || '未知';
            const time = button.getAttribute('data-time') || '未知';
            
            showEventMessage(message, type, reason, object, time);
        }

        let currentEventData = {};

        function showEventMessage(message, type, reason, object, time) {
            const modal = document.getElementById('eventMessageModal');
            
            // 保存当前事件数据供AI分析使用
            currentEventData = {
                message: message || '无消息',
                type: type || 'Normal',
                reason: reason || '未知',
                object: object || '未知',
                time: time || '未知'
            };
            
            // 安全地设置文本内容，处理特殊字符
            const messageEl = document.getElementById('modal-event-message');
            messageEl.textContent = currentEventData.message;
            
            document.getElementById('modal-event-reason').textContent = currentEventData.reason;
            document.getElementById('modal-event-object').textContent = currentEventData.object;
            document.getElementById('modal-event-time').textContent = currentEventData.time;
            
            // 设置类型标签
            const typeElement = document.getElementById('modal-event-type');
            typeElement.textContent = currentEventData.type;
            typeElement.className = 'px-2 py-1 rounded text-xs font-bold ' + 
                (currentEventData.type === 'Warning' ? 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400' : 
                 'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-300');
            
            // 重置AI分析区域
            document.getElementById('ai-analysis-section').classList.add('hidden');
            document.getElementById('ai-analysis-loading').classList.add('hidden');
            document.getElementById('ai-analysis-content').classList.add('hidden');
            document.getElementById('ai-analysis-error').classList.add('hidden');
            document.getElementById('ai-analysis-btn').disabled = false;
            
            modal.classList.remove('hidden');
            modal.showModal();
        }

        function analyzeEventWithAI() {
            const btn = document.getElementById('ai-analysis-btn');
            const analysisSection = document.getElementById('ai-analysis-section');
            const loadingDiv = document.getElementById('ai-analysis-loading');
            const contentDiv = document.getElementById('ai-analysis-content');
            const errorDiv = document.getElementById('ai-analysis-error');
            
            // 显示分析区域和加载状态
            analysisSection.classList.remove('hidden');
            loadingDiv.classList.remove('hidden');
            contentDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            btn.disabled = true;
            
            // 发送请求到后端
            fetch('/dashboard/analyze-event', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: currentEventData.message,
                    type: currentEventData.type,
                    reason: currentEventData.reason,
                    object: currentEventData.object
                })
            })
            .then(response => response.json())
            .then(data => {
                loadingDiv.classList.add('hidden');
                
                if (data.success && data.analysis) {
                    // 使用 marked.js 渲染 Markdown
                    const analysisText = data.analysis;
                    const htmlContent = marked.parse(analysisText, {
                        breaks: true, // 支持换行
                        gfm: true, // GitHub Flavored Markdown
                        headerIds: false,
                        mangle: false
                    });
                    
                    const analysisElement = document.getElementById('ai-analysis-text');
                    analysisElement.innerHTML = htmlContent;
                    
                    // 高亮代码块
                    analysisElement.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                    
                    contentDiv.classList.remove('hidden');
                } else {
                    errorDiv.textContent = data.error || 'AI分析失败，请稍后重试';
                    errorDiv.classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('AI分析请求失败:', error);
                loadingDiv.classList.add('hidden');
                errorDiv.textContent = 'AI分析请求失败: ' + error.message;
                errorDiv.classList.remove('hidden');
            })
            .finally(() => {
                btn.disabled = false;
            });
        }

        function closeEventMessageModal() {
            const modal = document.getElementById('eventMessageModal');
            modal.classList.add('hidden');
            modal.close();
        }

        // ESC键关闭模态框
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEventMessageModal();
            }
        });
    </script>
</body>

</html>