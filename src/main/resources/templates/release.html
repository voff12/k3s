<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>应用发布 - Phoenix-Core</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#1a90ff",
                        "bg-main": "#f0f2f5",
                        "success": "#22c55e",
                        "warning": "#f59e0b",
                        "danger": "#ef4444",
                        "harbor": "#60b5f6",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "mono": ["JetBrains Mono", "Menlo", "monospace"]
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
        }

        .console-area::-webkit-scrollbar {
            width: 8px;
        }

        .console-area::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .console-area::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(26, 144, 255, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(26, 144, 255, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(26, 144, 255, 0);
            }
        }

        .step-active {
            animation: pulse-ring 2s infinite;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>

<body class="bg-bg-main font-display text-slate-800">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0">
            <div class="p-6 flex items-center gap-3 border-b border-slate-100">
                <div class="bg-gradient-to-br from-primary to-blue-600 p-1.5 rounded-lg">
                    <span class="material-symbols-outlined text-white">rocket_launch</span>
                </div>
                <span class="font-bold text-lg tracking-tight">Phoenix Release</span>
            </div>
            <nav class="flex-1 p-4 space-y-1">
                <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 text-primary font-medium"
                    href="/release">
                    <span class="material-symbols-outlined">deployed_code</span>
                    <span>应用发布</span>
                </a>
                <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors"
                    href="/devops">
                    <span class="material-symbols-outlined">account_tree</span>
                    <span>流水线</span>
                </a>
                <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors"
                    href="/pods">
                    <span class="material-symbols-outlined">view_in_ar</span>
                    <span>Pod 管理</span>
                </a>
                <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors"
                    href="/dashboard">
                    <span class="material-symbols-outlined">dashboard</span>
                    <span>集群总览</span>
                </a>
                <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors"
                    href="/store">
                    <span class="material-symbols-outlined">storage</span>
                    <span>存储管理</span>
                </a>
            </nav>
            <div class="p-4 border-t border-slate-100">
                <div class="flex items-center gap-3 p-2 rounded-xl bg-slate-50 border border-slate-100">
                    <div
                        class="size-10 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white font-bold text-sm">
                        SRE
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-semibold truncate">SRE 工程师</p>
                        <p class="text-xs text-slate-500 truncate">发布管理平台</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shrink-0">
                <div class="flex items-center gap-4">
                    <h1 class="text-lg font-bold text-slate-900">应用发布管理</h1>
                    <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded-full">K8s Job + Harbor +
                        K3s</span>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="refreshReleases()"
                        class="p-2 text-slate-500 hover:text-primary hover:bg-primary/5 rounded-lg transition-colors"
                        title="刷新">
                        <span class="material-symbols-outlined">refresh</span>
                    </button>
                    <button onclick="showNewReleaseModal()"
                        class="bg-gradient-to-r from-primary to-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:shadow-lg hover:shadow-primary/25 transition-all flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">rocket_launch</span>
                        新建发布
                    </button>
                </div>
            </header>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <div class="max-w-7xl mx-auto space-y-6">

                    <!-- Active Release Panel (hidden by default) -->
                    <div id="activeReleasePanel" class="hidden fade-in">
                        <!-- Status & Stepper -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-6">
                            <div class="flex items-center justify-between mb-8">
                                <div>
                                    <div class="flex items-center gap-3">
                                        <h2 class="text-xl font-bold text-slate-900">
                                            发布 #<span id="releaseId">—</span>
                                        </h2>
                                        <span id="statusBadge"
                                            class="px-2.5 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                        </span>
                                    </div>
                                    <p class="text-sm text-slate-500 mt-1">
                                        <span id="releaseMeta"></span> •
                                        耗时 <span id="releaseDuration" class="font-mono font-medium">00:00</span>
                                    </p>
                                </div>
                                <button onclick="closeActivePanel()"
                                    class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>

                            <!-- Release Stepper (3 steps: 0-2) -->
                            <div class="relative flex justify-between" id="releaseStepper">
                                <div class="absolute top-5 left-[12%] right-[12%] h-0.5 bg-slate-100"></div>
                                <div id="stepperProgress"
                                    class="absolute top-5 left-[12%] h-0.5 bg-primary transition-all duration-700"
                                    style="width:0%"></div>

                                <!-- Step 0: Build & Push -->
                                <div class="flex flex-col items-center gap-2 bg-white px-4 z-10" data-step="0">
                                    <div id="step0"
                                        class="size-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center transition-all duration-300">
                                        <span class="material-symbols-outlined">deployed_code_update</span>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-xs font-bold">构建发布</p>
                                        <p class="text-[10px] text-slate-400" id="step0label">等待中</p>
                                    </div>
                                </div>
                                <!-- Step 1: Deploy -->
                                <div class="flex flex-col items-center gap-2 bg-white px-4 z-10" data-step="1">
                                    <div id="step1"
                                        class="size-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center transition-all duration-300">
                                        <span class="material-symbols-outlined">rocket_launch</span>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-xs font-bold">K3s 部署</p>
                                        <p class="text-[10px] text-slate-400" id="step1label">等待中</p>
                                    </div>
                                </div>
                                <!-- Step 2: Done -->
                                <div class="flex flex-col items-center gap-2 bg-white px-4 z-10" data-step="2">
                                    <div id="step2"
                                        class="size-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center transition-all duration-300">
                                        <span class="material-symbols-outlined">check_circle</span>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-xs font-bold">完成</p>
                                        <p class="text-[10px] text-slate-400" id="step2label">等待中</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Console + Info Grid -->
                        <div class="grid grid-cols-12 gap-6">
                            <!-- Console Output -->
                            <div class="col-span-8">
                                <div
                                    class="bg-slate-900 rounded-xl overflow-hidden shadow-lg border border-slate-700/50">
                                    <div class="bg-slate-800 px-4 py-2.5 flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="flex gap-1.5">
                                                <div class="size-3 rounded-full bg-red-500/80"></div>
                                                <div class="size-3 rounded-full bg-yellow-500/80"></div>
                                                <div class="size-3 rounded-full bg-green-500/80"></div>
                                            </div>
                                            <span class="text-xs text-slate-400 font-mono">发布日志 (SSE 实时)</span>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <label class="flex items-center gap-2 cursor-pointer select-none">
                                                <span
                                                    class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">自动滚动</span>
                                                <input type="checkbox" id="autoScroll" checked class="sr-only peer" />
                                                <div
                                                    class="w-8 h-4 bg-slate-600 rounded-full relative peer-checked:bg-primary transition-colors">
                                                    <div
                                                        class="absolute top-0.5 left-0.5 size-3 bg-white rounded-full transition-transform peer-checked:translate-x-4">
                                                    </div>
                                                </div>
                                            </label>
                                            <button onclick="clearConsole()"
                                                class="text-slate-500 hover:text-slate-300 transition-colors"
                                                title="清空">
                                                <span class="material-symbols-outlined text-lg">delete</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="consoleOutput"
                                        class="p-4 font-mono text-sm h-[420px] overflow-y-auto console-area text-slate-300 leading-relaxed space-y-0.5">
                                        <p class="text-slate-600 italic">等待发布启动...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Sidebar Info -->
                            <div class="col-span-4 space-y-4">
                                <!-- Release Config -->
                                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                                    <h4 class="text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
                                        <span class="material-symbols-outlined text-primary text-lg">settings</span>
                                        发布配置
                                    </h4>
                                    <div class="space-y-3">
                                        <div class="p-2.5 bg-slate-50 rounded-lg border border-slate-100">
                                            <p
                                                class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-0.5">
                                                Git 仓库</p>
                                            <p class="text-xs font-mono text-slate-700 truncate" id="infoGitUrl">—</p>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="p-2.5 bg-slate-50 rounded-lg border border-slate-100">
                                                <p
                                                    class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-0.5">
                                                    分支</p>
                                                <p class="text-xs font-mono text-slate-700" id="infoBranch">—</p>
                                            </div>
                                            <div class="p-2.5 bg-slate-50 rounded-lg border border-slate-100">
                                                <p
                                                    class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-0.5">
                                                    镜像名</p>
                                                <p class="text-xs font-mono text-slate-700 truncate" id="infoImage">—
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Architecture Info -->
                                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                                    <h4 class="text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
                                        <span class="material-symbols-outlined text-primary text-lg">lan</span>
                                        基础架构
                                    </h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center text-xs">
                                            <span class="text-slate-500">构建引擎</span>
                                            <span class="font-mono font-medium text-slate-700">K8s Job</span>
                                        </div>
                                        <div class="flex justify-between items-center text-xs">
                                            <span class="text-slate-500">代码构建</span>
                                            <span class="font-mono font-medium text-slate-700">Maven 3.9</span>
                                        </div>
                                        <div class="flex justify-between items-center text-xs">
                                            <span class="text-slate-500">镜像构建</span>
                                            <span class="font-mono font-medium text-slate-700">Kaniko</span>
                                        </div>
                                        <div class="flex justify-between items-center text-xs">
                                            <span class="text-slate-500">镜像仓库</span>
                                            <span class="font-mono font-medium text-harbor">Harbor</span>
                                        </div>
                                        <div class="flex justify-between items-center text-xs">
                                            <span class="text-slate-500">消息推送</span>
                                            <span class="font-mono font-medium text-primary">SSE 实时</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Deploy Target -->
                                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                                    <h4 class="text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
                                        <span class="material-symbols-outlined text-primary text-lg">cloud_done</span>
                                        部署目标
                                    </h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center text-xs">
                                            <span class="text-slate-500">Harbor 项目</span>
                                            <span class="font-mono font-medium text-harbor"
                                                id="infoHarborProject">library</span>
                                        </div>
                                        <div class="flex justify-between items-center text-xs">
                                            <span class="text-slate-500">命名空间</span>
                                            <span class="font-mono font-medium text-slate-700"
                                                id="infoNamespace">default</span>
                                        </div>
                                        <div class="flex justify-between items-center text-xs">
                                            <span class="text-slate-500">Deployment</span>
                                            <span class="font-mono font-medium text-slate-700"
                                                id="infoDeployment">—</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Release History -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="font-bold text-slate-900 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">history</span>
                                发布历史
                            </h3>
                            <span class="text-xs text-slate-400" id="historyCount">0 条记录</span>
                        </div>
                        <div id="releaseHistory">
                            <!-- Thymeleaf server-rendered history -->
                            <div th:if="${#lists.isEmpty(releases)}" class="p-12 text-center">
                                <span
                                    class="material-symbols-outlined text-5xl text-slate-300 mb-3">deployed_code</span>
                                <p class="text-slate-400 text-sm">暂无发布记录</p>
                                <p class="text-slate-300 text-xs mt-1">点击右上角「新建发布」开始第一次应用发布</p>
                            </div>
                            <div th:unless="${#lists.isEmpty(releases)}">
                                <div th:each="r : ${releases}"
                                    class="px-6 py-4 border-b border-slate-50 hover:bg-slate-50/50 transition-colors cursor-pointer flex items-center justify-between"
                                    th:data-release-id="${r.id}" onclick="viewRelease(this.dataset.releaseId)">
                                    <div class="flex items-center gap-4">
                                        <div th:classappend="${r.status.name() == 'SUCCESS'} ? 'bg-success text-white' : (${r.status.name() == 'FAILED'} ? 'bg-danger text-white' : 'bg-primary text-white')"
                                            class="size-9 rounded-lg flex items-center justify-center">
                                            <span th:if="${r.status.name() == 'SUCCESS'}"
                                                class="material-symbols-outlined text-lg">check</span>
                                            <span th:if="${r.status.name() == 'FAILED'}"
                                                class="material-symbols-outlined text-lg">close</span>
                                            <span
                                                th:if="${r.status.name() != 'SUCCESS' and r.status.name() != 'FAILED'}"
                                                class="material-symbols-outlined text-lg animate-spin">sync</span>
                                        </div>
                                        <div>
                                            <p class="text-sm font-semibold text-slate-900">
                                                #<span th:text="${r.id}"></span>
                                                <span class="font-normal text-slate-500"
                                                    th:text="' — ' + ${r.config.imageName}"></span>
                                            </p>
                                            <p class="text-xs text-slate-400" th:text="${r.startTimeFormatted}"></p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <span class="text-xs font-mono text-slate-500" th:text="${r.duration}"></span>
                                        <span
                                            th:classappend="${r.status.name() == 'SUCCESS'} ? 'bg-success/10 text-success' : (${r.status.name() == 'FAILED'} ? 'bg-danger/10 text-danger' : 'bg-primary/10 text-primary')"
                                            class="px-2 py-0.5 rounded-full text-xs font-bold"
                                            th:text="${r.status.label}">
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- New Release Modal -->
    <div id="releaseModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="hideNewReleaseModal()"></div>
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl w-[560px] max-h-[85vh] overflow-auto fade-in">
            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                <h3 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">rocket_launch</span>
                    新建应用发布
                </h3>
                <button onclick="hideNewReleaseModal()" class="text-slate-400 hover:text-slate-600">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6 space-y-5">
                <!-- Git URL -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Git 仓库地址 <span
                            class="text-danger">*</span></label>
                    <div class="relative">
                        <span
                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg">link</span>
                        <input type="text" id="formGitUrl" placeholder="https://github.com/user/repo.git"
                            class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-colors" />
                    </div>
                </div>
                <!-- Branch + Image Name -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Git
                            分支</label>
                        <input type="text" id="formBranch" value="main" placeholder="main"
                            class="w-full px-3 py-2.5 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary" />
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">镜像名称 <span
                                class="text-danger">*</span></label>
                        <input type="text" id="formImageName" placeholder="my-app"
                            class="w-full px-3 py-2.5 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary" />
                    </div>
                </div>
                <!-- Tag + Harbor Project -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">镜像
                            Tag</label>
                        <input type="text" id="formImageTag" value="latest" placeholder="latest"
                            class="w-full px-3 py-2.5 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary" />
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Harbor
                            项目</label>
                        <input type="text" id="formHarborProject" value="library" placeholder="library"
                            class="w-full px-3 py-2.5 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary" />
                    </div>
                </div>
                <!-- Dockerfile + Build Command -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Dockerfile
                            路径</label>
                        <input type="text" id="formDockerfile" value="./Dockerfile" placeholder="./Dockerfile"
                            class="w-full px-3 py-2.5 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary" />
                    </div>
                    <div>
                        <label
                            class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">构建命令</label>
                        <input type="text" id="formBuildCommand" value="mvn clean package -DskipTests"
                            placeholder="mvn clean package"
                            class="w-full px-3 py-2.5 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary font-mono" />
                    </div>
                </div>
                <!-- Namespace + Deployment -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">K3s
                            命名空间</label>
                        <input type="text" id="formNamespace" value="default" placeholder="default"
                            class="w-full px-3 py-2.5 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary" />
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Deployment
                            名称</label>
                        <input type="text" id="formDeployment" placeholder="留空则仅构建推送镜像"
                            class="w-full px-3 py-2.5 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary" />
                    </div>
                </div>
                <!-- Git Token + Git 代理 -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Git Token
                            <span class="text-slate-400 font-normal normal-case">(私有仓库)</span></label>
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg">key</span>
                            <input type="password" id="formGitToken" placeholder="留空则使用全局配置或公开访问"
                                class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Git 代理
                            <span class="text-slate-400 font-normal normal-case">(无法直连 GitHub 时)</span></label>
                        <input type="text" id="formGitProxy" placeholder="例: http://10.0.0.1:7890，留空则用 application.properties"
                            class="w-full px-3 py-2.5 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary font-mono" />
                    </div>
                </div>
                <!-- Hint -->
                <div class="flex items-start gap-2 p-3 bg-blue-50 rounded-lg border border-blue-100">
                    <span class="material-symbols-outlined text-primary text-lg mt-0.5">info</span>
                    <p class="text-xs text-blue-700 leading-relaxed">
                        发布流程: K8s Job 自动编排 → 克隆代码 → Maven 构建 + Kaniko 镜像构建推送 Harbor → kubectl 部署
                        K3s。全程 SSE 实时日志推送。
                    </p>
                </div>
            </div>
            <div class="p-6 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="hideNewReleaseModal()"
                    class="px-4 py-2.5 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                    取消
                </button>
                <button onclick="submitRelease()"
                    class="px-6 py-2.5 bg-gradient-to-r from-primary to-blue-600 text-white text-sm font-semibold rounded-lg hover:shadow-lg hover:shadow-primary/25 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-sm">rocket_launch</span>
                    开始发布
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== State ==========
        let currentEventSource = null;
        let currentReleaseId = null;
        let autoScroll = true;

        document.getElementById('autoScroll').addEventListener('change', function () {
            autoScroll = this.checked;
        });

        // ========== Modal ==========
        function showNewReleaseModal() {
            document.getElementById('releaseModal').classList.remove('hidden');
        }
        function hideNewReleaseModal() {
            document.getElementById('releaseModal').classList.add('hidden');
        }

        // ========== Submit Release ==========
        async function submitRelease() {
            const gitUrl = document.getElementById('formGitUrl').value.trim();
            const imageName = document.getElementById('formImageName').value.trim();

            if (!gitUrl) { alert('请输入 Git 仓库地址'); return; }
            if (!imageName) { alert('请输入镜像名称'); return; }

            const config = {
                gitUrl: gitUrl,
                branch: document.getElementById('formBranch').value.trim() || 'main',
                imageName: imageName,
                imageTag: document.getElementById('formImageTag').value.trim() || 'latest',
                namespace: document.getElementById('formNamespace').value.trim() || 'default',
                deploymentName: document.getElementById('formDeployment').value.trim(),
                dockerfilePath: document.getElementById('formDockerfile').value.trim() || './Dockerfile',
                gitToken: document.getElementById('formGitToken').value.trim(),
                gitProxy: document.getElementById('formGitProxy').value.trim(),
                buildCommand: document.getElementById('formBuildCommand').value.trim(),
                harborProject: document.getElementById('formHarborProject').value.trim() || 'library'
            };

            try {
                const resp = await fetch('/release/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await resp.json();

                if (data.success) {
                    hideNewReleaseModal();
                    activateRelease(data.id, config);
                } else {
                    alert('错误: ' + data.error);
                }
            } catch (e) {
                console.error('Release error:', e);
                alert('请求失败: ' + e.message);
            }
        }

        // ========== Activate Release View ==========
        function activateRelease(id, config) {
            currentReleaseId = id;
            const panel = document.getElementById('activeReleasePanel');
            panel.classList.remove('hidden');

            document.getElementById('releaseId').textContent = id;
            document.getElementById('releaseMeta').textContent = config ? config.gitUrl : '';
            document.getElementById('infoGitUrl').textContent = config ? config.gitUrl : '—';
            document.getElementById('infoBranch').textContent = config ? config.branch : '—';
            document.getElementById('infoImage').textContent = config ? (config.imageName + ':' + config.imageTag) : '—';
            document.getElementById('infoHarborProject').textContent = config ? config.harborProject : 'library';
            document.getElementById('infoNamespace').textContent = config ? config.namespace : 'default';
            document.getElementById('infoDeployment').textContent = config && config.deploymentName ? config.deploymentName : '未指定';

            resetStepper();
            clearConsole();
            connectSSE(id);
            panel.scrollIntoView({ behavior: 'smooth' });
        }

        // ========== SSE Connection ==========
        function connectSSE(releaseId) {
            if (currentEventSource) {
                currentEventSource.close();
            }

            const es = new EventSource('/release/' + releaseId + '/stream');
            currentEventSource = es;

            es.addEventListener('init', function (e) {
                const data = JSON.parse(e.data);
                updateStatus(data);
                if (data.logs && data.logs.length > 0) {
                    const consoleEl = document.getElementById('consoleOutput');
                    consoleEl.innerHTML = '';
                    data.logs.forEach(line => appendLogLine(line));
                }
            });

            es.addEventListener('log', function (e) {
                const data = JSON.parse(e.data);
                if (data.full && data.logs && data.logs.length > 0) {
                    const consoleEl = document.getElementById('consoleOutput');
                    const placeholder = consoleEl.querySelector('.italic');
                    if (placeholder) placeholder.remove();
                    consoleEl.innerHTML = '';
                    data.logs.forEach(line => appendLogLine(line));
                } else if (data.line) {
                    appendLogLine(data.line);
                }
            });

            es.addEventListener('status', function (e) {
                const data = JSON.parse(e.data);
                updateStatus(data);
            });

            es.addEventListener('complete', function (e) {
                es.close();
                currentEventSource = null;
                refreshReleases();
            });

            es.onerror = function () {
                es.close();
                currentEventSource = null;
            };
        }

        // ========== Console ==========
        function appendLogLine(line) {
            const consoleEl = document.getElementById('consoleOutput');
            const placeholder = consoleEl.querySelector('.italic');
            if (placeholder) placeholder.remove();

            const p = document.createElement('p');
            let html = escapeHtml(line);
            html = html.replace(/\[INFO\]/g, '<span class="text-blue-400">[INFO]</span>');
            html = html.replace(/\[WARN\]/g, '<span class="text-yellow-400">[WARN]</span>');
            html = html.replace(/\[WARNING\]/g, '<span class="text-yellow-400">[WARNING]</span>');
            html = html.replace(/\[ERROR\]/g, '<span class="text-red-400">[ERROR]</span>');
            html = html.replace(/✓/g, '<span class="text-green-400">✓</span>');
            html = html.replace(/➜/g, '<span class="text-primary">➜</span>');

            p.innerHTML = html;
            p.className = 'text-slate-400 fade-in';
            consoleEl.appendChild(p);

            if (autoScroll) {
                consoleEl.scrollTop = consoleEl.scrollHeight;
            }
        }

        function clearConsole() {
            document.getElementById('consoleOutput').innerHTML =
                '<p class="text-slate-600 italic">等待发布启动...</p>';
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ========== Stepper (3 steps: 0-2) ==========
        const stepNames = ['构建发布', 'K3s 部署', '完成'];

        function resetStepper() {
            for (let i = 0; i <= 2; i++) {
                const el = document.getElementById('step' + i);
                const labelEl = document.getElementById('step' + i + 'label');
                if (!el || !labelEl) continue;
                el.className = 'size-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center transition-all duration-300';
                labelEl.textContent = '等待中';
                labelEl.className = 'text-[10px] text-slate-400';
            }
            const progress = document.getElementById('stepperProgress');
            if (progress) progress.style.width = '0%';
            updateStatusBadge('PENDING', '等待中');
        }

        function updateStatus(data) {
            const step = data.currentStep;
            const status = data.status;
            const label = data.statusLabel;
            const finished = data.finished;
            const duration = data.duration;

            updateStatusBadge(status, label);

            if (duration) {
                document.getElementById('releaseDuration').textContent = duration;
            }

            // Update stepper (3 steps: 0-2)
            for (let i = 0; i <= 2; i++) {
                const el = document.getElementById('step' + i);
                const labelEl = document.getElementById('step' + i + 'label');
                if (!el || !labelEl) continue;

                if (i < step) {
                    el.className = 'size-10 rounded-full bg-success text-white flex items-center justify-center transition-all duration-300';
                    el.innerHTML = '<span class="material-symbols-outlined">check</span>';
                    labelEl.textContent = '完成';
                    labelEl.className = 'text-[10px] text-success font-medium';
                } else if (i === step && !finished) {
                    el.className = 'size-10 rounded-full bg-primary text-white flex items-center justify-center transition-all duration-300 step-active';
                    el.innerHTML = '<span class="material-symbols-outlined animate-spin">sync</span>';
                    labelEl.textContent = '进行中';
                    labelEl.className = 'text-[10px] text-primary font-medium';
                } else if (i === step && finished) {
                    if (status === 'SUCCESS') {
                        el.className = 'size-10 rounded-full bg-success text-white flex items-center justify-center transition-all duration-300';
                        el.innerHTML = '<span class="material-symbols-outlined">check_circle</span>';
                        labelEl.textContent = '成功';
                        labelEl.className = 'text-[10px] text-success font-medium';
                    } else {
                        el.className = 'size-10 rounded-full bg-danger text-white flex items-center justify-center transition-all duration-300';
                        el.innerHTML = '<span class="material-symbols-outlined">error</span>';
                        labelEl.textContent = '失败';
                        labelEl.className = 'text-[10px] text-danger font-medium';
                    }
                } else {
                    // Future steps
                    const icons = ['deployed_code_update', 'rocket_launch', 'check_circle'];
                    el.className = 'size-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center transition-all duration-300';
                    el.innerHTML = '<span class="material-symbols-outlined">' + icons[i] + '</span>';
                    labelEl.textContent = '等待中';
                    labelEl.className = 'text-[10px] text-slate-400';
                }
            }

            // Progress bar
            const progress = document.getElementById('stepperProgress');
            if (progress) {
                const pct = Math.min(100, Math.max(0, (step / 2) * 76));
                progress.style.width = pct + '%';
            }
        }

        function updateStatusBadge(status, label) {
            const badge = document.getElementById('statusBadge');
            if (!badge) return;
            badge.textContent = label;
            badge.className = 'px-2.5 py-1 rounded-full text-xs font-bold flex items-center gap-1 ';
            if (status === 'SUCCESS') {
                badge.className += 'bg-success/10 text-success';
            } else if (status === 'FAILED') {
                badge.className += 'bg-danger/10 text-danger';
            } else {
                badge.className += 'bg-primary/10 text-primary';
            }
        }

        function closeActivePanel() {
            document.getElementById('activeReleasePanel').classList.add('hidden');
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
            }
        }

        // ========== View Existing Release ==========
        async function viewRelease(id) {
            try {
                const resp = await fetch('/release/' + id + '/status');
                const data = await resp.json();
                if (data.success) {
                    activateRelease(id, {
                        gitUrl: data.gitUrl,
                        branch: data.branch,
                        imageName: data.imageName,
                        imageTag: 'latest',
                        namespace: 'default',
                        harborProject: 'library'
                    });
                }
            } catch (e) {
                console.error('View release error:', e);
            }
        }

        // ========== Refresh ==========
        async function refreshReleases() {
            try {
                const resp = await fetch('/release/list');
                const releases = await resp.json();
                const container = document.getElementById('releaseHistory');
                document.getElementById('historyCount').textContent = releases.length + ' 条记录';

                if (releases.length === 0) {
                    container.innerHTML = `
                        <div class="p-12 text-center">
                            <span class="material-symbols-outlined text-5xl text-slate-300 mb-3">deployed_code</span>
                            <p class="text-slate-400 text-sm">暂无发布记录</p>
                            <p class="text-slate-300 text-xs mt-1">点击右上角「新建发布」开始第一次应用发布</p>
                        </div>`;
                    return;
                }

                container.innerHTML = releases.map(r => {
                    const statusClass = r.status === 'SUCCESS' ? 'bg-success text-white' :
                        r.status === 'FAILED' ? 'bg-danger text-white' : 'bg-primary text-white';
                    const statusIcon = r.status === 'SUCCESS' ? 'check' :
                        r.status === 'FAILED' ? 'close' : 'sync';
                    const iconExtra = (r.status !== 'SUCCESS' && r.status !== 'FAILED') ? ' animate-spin' : '';
                    const badgeClass = r.status === 'SUCCESS' ? 'bg-success/10 text-success' :
                        r.status === 'FAILED' ? 'bg-danger/10 text-danger' : 'bg-primary/10 text-primary';

                    return `<div class="px-6 py-4 border-b border-slate-50 hover:bg-slate-50/50 transition-colors cursor-pointer flex items-center justify-between"
                                onclick="viewRelease('${r.id}')">
                        <div class="flex items-center gap-4">
                            <div class="size-9 rounded-lg flex items-center justify-center ${statusClass}">
                                <span class="material-symbols-outlined text-lg${iconExtra}">${statusIcon}</span>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-slate-900">#${r.id} <span class="font-normal text-slate-500"> — ${r.imageName}</span></p>
                                <p class="text-xs text-slate-400">${r.startTime}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-mono text-slate-500">${r.duration}</span>
                            <span class="px-2 py-0.5 rounded-full text-xs font-bold ${badgeClass}">${r.statusLabel}</span>
                        </div>
                    </div>`;
                }).join('');
            } catch (e) {
                console.error('Refresh error:', e);
            }
        }
    </script>
</body>

</html>